using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Windows.UI;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.Entities;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.Interfaces;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.Services;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.ImportData;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.ExportData;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.InitializeGrid;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.SearchGrid;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.ManageRows;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Infrastructure.Services;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.SharedKernel.Results;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.Core;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.Configuration;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.DataOperations;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.SearchAndFilter;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.Validation;
using RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Domain.ValueObjects.UI;

namespace RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.UI.Components;

/// <summary>
/// UI: DataGrid business logic component wrapper
/// CLEAN ARCHITECTURE: UI layer - Business logic wrapper for XAML UserControl
/// RESPONSIBILITY: Handle business logic and coordinate with application services
/// SENIOR DESIGN: Separated from XAML to maintain clean architecture
/// </summary>
internal sealed class DataGridComponentLogic : IDisposable
{
    #region UI: Private Fields

    private readonly AdvancedDataGridComponent _xamlComponent;
    private IDataGridService? _dataGridService;
    private IDataGridAutoRowHeightService? _autoRowHeightService;
    private GridState? _currentState;
    private bool _isDisposed;
    private ILogger? _logger;
    private ObservableCollection<DataGridRowViewModel>? _displayData;

    #endregion

    #region UI: Constructor

    /// <summary>
    /// SENIOR DESIGN: Business logic constructor - no XAML dependencies
    /// CLEAN ARCHITECTURE: Initialize services and data without UI coupling
    /// </summary>
    public DataGridComponentLogic(AdvancedDataGridComponent xamlComponent)
    {
        _xamlComponent = xamlComponent ?? throw new ArgumentNullException(nameof(xamlComponent));

        // Initialize the display data collection
        _displayData = new ObservableCollection<DataGridRowViewModel>();

        InitializeServices();

        // SENIOR DESIGN: Delayed binding - will be done when UI elements are ready
        SetupUIBindings();
    }

    /// <summary>
    /// SENIOR DESIGN: Setup UI bindings and event handlers safely
    /// CLEAN ARCHITECTURE: Bridge between XAML events and business logic
    /// </summary>
    private void SetupUIBindings()
    {
        try
        {
            // SENIOR DESIGN: Safe binding to UI elements - may not be ready yet
            var mainDataView = _xamlComponent.GetMainDataView();
            if (mainDataView != null && _displayData != null)
            {
                mainDataView.ItemsSource = _displayData;

                // Setup event handlers - ItemsControl doesn't have ItemClick/SelectionChanged
                // Event handling is done at the cell level in the DataTemplate

                _logger?.LogInformation("UI bindings established successfully");
            }
            else
            {
                _logger?.LogWarning("UI elements not ready for binding - will retry later");
            }
        }
        catch (Exception ex)
        {
            _logger?.LogWarning("UI binding failed - elements not ready yet: {Error}", ex.Message);
            // SENIOR DESIGN: Graceful degradation - UI binding will be retried when needed
        }
    }

    /// <summary>
    /// SENIOR DESIGN: Ensure UI bindings are established before operations
    /// CLEAN ARCHITECTURE: Lazy binding pattern for UI safety
    /// </summary>
    private void EnsureUIBindings()
    {
        _logger?.LogInformation("[UI-BINDING] Starting EnsureUIBindings");

        var mainDataView = _xamlComponent.GetMainDataView();
        _logger?.LogInformation("[UI-BINDING] MainDataView retrieved: {IsNull}", mainDataView == null ? "NULL" : "OK");

        if (mainDataView != null)
        {
            _logger?.LogInformation("[UI-BINDING] MainDataView ItemsSource is: {IsNull}", mainDataView.ItemsSource == null ? "NULL" : "SET");
            _logger?.LogInformation("[UI-BINDING] Display data collection is: {IsNull}", _displayData == null ? "NULL" : "OK");

            if (mainDataView.ItemsSource == null && _displayData != null)
            {
                try
                {
                    _logger?.LogInformation("[UI-BINDING] Setting ItemsSource to display data collection (Count: {Count})", _displayData.Count);
                    mainDataView.ItemsSource = _displayData;
                    _logger?.LogInformation("[UI-BINDING] UI bindings established successfully");
                }
                catch (Exception ex)
                {
                    _logger?.LogError(ex, "[UI-BINDING] Failed to establish UI bindings: {ErrorMessage}", ex.Message);
                }
            }
            else
            {
                _logger?.LogInformation("[UI-BINDING] UI bindings already established or display data is null");
            }
        }
        else
        {
            _logger?.LogWarning("[UI-BINDING] MainDataView is null - cannot establish UI bindings");
        }
    }

    #endregion

    #region UI: Public Properties
    
    /// <summary>
    /// Current grid state
    /// </summary>
    public GridState? CurrentState => _currentState;
    
    /// <summary>
    /// Is the grid initialized
    /// </summary>
    public bool IsInitialized => _currentState != null && _currentState.IsInitialized;
    
    /// <summary>
    /// Total row count
    /// </summary>
    public int TotalRowCount => _displayData?.Count ?? _currentState?.Rows?.Count ?? 0;
    
    /// <summary>
    /// Filtered row count
    /// </summary>
    public int FilteredRowCount => _currentState?.FilteredRowIndices?.Count ?? _currentState?.Rows.Count ?? 0;
    
    #endregion

    #region UI: Events
    
    /// <summary>
    /// Raised when data changes
    /// </summary>
    public event EventHandler<DataChangedEventArgs>? DataChanged;
    
    /// <summary>
    /// Raised when validation completes
    /// </summary>
    public event EventHandler<ValidationCompletedEventArgs>? ValidationCompleted;
    
    /// <summary>
    /// Raised when import/export operations complete
    /// </summary>
    public event EventHandler<OperationCompletedEventArgs>? OperationCompleted;
    
    /// <summary>
    /// Raised when errors occur
    /// </summary>
    public event EventHandler<ErrorEventArgs>? ErrorOccurred;
    
    /// <summary>
    /// Raised when item is clicked in data view
    /// </summary>
    public event EventHandler<ItemClickedEventArgs>? ItemClicked;
    
    /// <summary>
    /// Raised when selection changes in data view
    /// </summary>
    public event EventHandler<DataGridSelectionChangedEventArgs>? SelectionChanged;
    
    #endregion

    #region UI: Initialization
    
    private void InitializeServices()
    {
        try
        {
            _dataGridService = DataGridServiceFactory.CreateWithUI(_logger);
            
            // Initialize auto row height service
            var uiConfiguration = UIConfiguration.Default;
            var uiService = new DataGridUIService(_logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger.Instance);
            var rowHeightService = new RowHeightCalculationService(
                _logger as ILogger<RowHeightCalculationService> ?? 
                Microsoft.Extensions.Logging.Abstractions.NullLogger<RowHeightCalculationService>.Instance);
            
            _autoRowHeightService = new DataGridAutoRowHeightService(
                rowHeightService, 
                uiService, 
                uiConfiguration,
                _logger as ILogger<DataGridAutoRowHeightService> ?? 
                Microsoft.Extensions.Logging.Abstractions.NullLogger<DataGridAutoRowHeightService>.Instance);
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Failed to initialize DataGrid services");
            OnErrorOccurred(new ErrorEventArgs($"Service initialization failed: {ex.Message}", ex));
        }
    }
    
    /// <summary>
    /// Initialize the DataGrid with column definitions
    /// </summary>
    public async Task<bool> InitializeAsync(
        IReadOnlyList<Domain.ValueObjects.Core.ColumnDefinition> columns,
        ColorConfiguration? colorConfiguration = null,
        ValidationConfiguration? validationConfiguration = null,
        PerformanceConfiguration? performanceConfiguration = null,
        int minimumRows = 1)
    {
        try
        {
            if (_dataGridService == null)
            {
                _logger?.LogError("DataGrid service not available");
                return false;
            }
            
            var result = await _dataGridService.InitializeAsync(
                columns,
                colorConfiguration,
                validationConfiguration,
                performanceConfiguration);
            
            if (result.IsSuccess)
            {
                // Note: GetCurrentStateAsync would need to be implemented or use alternative approach
                //_currentState = await GetCurrentStateAsync();
                await RefreshUIAsync();
                OnDataChanged(new DataChangedEventArgs("Initialize", TotalRowCount));
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Initialization failed: {result.Error}", result.Exception));
            }
            
            return result.IsSuccess;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "DataGrid initialization failed");
            OnErrorOccurred(new ErrorEventArgs($"Initialization failed: {ex.Message}", ex));
            return false;
        }
    }

    /// <summary>
    /// Initialize the DataGrid with sample data for demonstration
    /// </summary>
    public async Task<bool> InitializeWithSampleDataAsync()
    {
        try
        {
            // Create sample columns
            var columns = new List<Domain.ValueObjects.Core.ColumnDefinition>
            {
                Domain.ValueObjects.Core.ColumnDefinition.Numeric<int>("ID", "ID"),
                Domain.ValueObjects.Core.ColumnDefinition.Required("Name", typeof(string), "Name"),
                Domain.ValueObjects.Core.ColumnDefinition.Text("Email", "Email"),
                Domain.ValueObjects.Core.ColumnDefinition.Text("Status", "Status")
            }.AsReadOnly();

            // Initialize the service if available
            if (_dataGridService != null)
            {
                var result = await _dataGridService.InitializeAsync(columns);
                if (!result.IsSuccess)
                {
                    _logger?.LogError("DataGrid service initialization failed: {Error}", result.Error);
                }
            }

            // Add sample data directly to UI
            await AddSampleDataToUI();

            // Update status displays
            await UpdateStatusDisplayAsync();

            _logger?.LogInformation("DataGrid initialized with {Count} sample rows", TotalRowCount);
            return true;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "DataGrid initialization failed");
            return false;
        }
    }

    private async Task AddSampleDataToUI()
    {
        _logger?.LogInformation("[DATA-LOADING] Starting to add sample data to UI");

        await Task.Run(() =>
        {
            var sampleData = new[]
            {
                new DataGridRowViewModel { ID = "1", Name = "John Doe", Email = "john.doe@example.com", Status = "Active", ValidationAlerts = "" },
                new DataGridRowViewModel { ID = "2", Name = "Jane Smith", Email = "jane.smith@example.com", Status = "Active", ValidationAlerts = "Email: Invalid domain format" },
                new DataGridRowViewModel { ID = "3", Name = "Mike Johnson", Email = "mike.johnson@example.com", Status = "Inactive", ValidationAlerts = "Status: Must be Active or Pending" },
                new DataGridRowViewModel { ID = "4", Name = "Sarah Williams", Email = "sarah.williams@example.com", Status = "Active", ValidationAlerts = "" },
                new DataGridRowViewModel { ID = "5", Name = "David Brown", Email = "david.brown@example.com", Status = "Pending", ValidationAlerts = "Name: Too long, Email: Missing TLD" }
            };

            _logger?.LogInformation("[DATA-LOADING] Created sample data array with {Count} items", sampleData.Length);

            _xamlComponent.DispatcherQueue.TryEnqueue(() =>
            {
                _logger?.LogInformation("[DATA-LOADING] Dispatcher queue execution started");

                try
                {
                    // SENIOR DESIGN: Ensure UI bindings are ready before adding data
                    _logger?.LogInformation("[DATA-LOADING] Ensuring UI bindings before adding data");
                    EnsureUIBindings();

                    if (_displayData != null)
                    {
                        _logger?.LogInformation("[DATA-LOADING] Display data collection is available, clearing and adding items");
                        _displayData.Clear();

                        foreach (var item in sampleData)
                        {
                            _displayData.Add(item);
                            _logger?.LogTrace("[DATA-LOADING] Added item: ID={ID}, Name={Name}", item.ID, item.Name);
                        }

                        _logger?.LogInformation("[DATA-LOADING] Sample data added to UI successfully: {Count} items", sampleData.Length);
                        _logger?.LogInformation("[DATA-LOADING] Final collection count: {CollectionCount}", _displayData.Count);
                    }
                    else
                    {
                        _logger?.LogError("[DATA-LOADING] Display data collection is null - cannot add sample data");
                    }
                }
                catch (Exception ex)
                {
                    _logger?.LogError(ex, "[DATA-LOADING] Error adding sample data to UI: {ErrorMessage}", ex.Message);
                }
            });
        });
    }

    private async Task UpdateStatusDisplayAsync()
    {
        try
        {
            await Task.Delay(10); // Ensure UI thread operations complete

            _xamlComponent.DispatcherQueue.TryEnqueue(() =>
            {
                var rowCountText = _xamlComponent.GetRowCountText();
                if (rowCountText != null)
                    rowCountText.Text = $"Rows: {TotalRowCount}";

                var filteredRowCountText = _xamlComponent.GetFilteredRowCountText();
                if (filteredRowCountText != null)
                    filteredRowCountText.Text = $"Filtered: {TotalRowCount}";

                var validationStatusText = _xamlComponent.GetValidationStatusText();
                if (validationStatusText != null)
                    validationStatusText.Text = "Valid";

                var operationStatusText = _xamlComponent.GetOperationStatusText();
                if (operationStatusText != null)
                    operationStatusText.Text = "Ready";
            });
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error updating status display");
        }
    }

    #endregion

    #region UI: Data Import/Export
    
    /// <summary>
    /// Import data from dictionary list
    /// </summary>
    public async Task<bool> ImportFromDictionaryAsync(
        List<Dictionary<string, object?>> data,
        Dictionary<int, bool>? checkboxStates = null,
        int startRow = 1,
        ImportMode mode = ImportMode.Replace,
        TimeSpan? timeout = null,
        IProgress<ValidationProgress>? progress = null)
    {
        try
        {
            if (_dataGridService == null) return false;
            
            var result = await _dataGridService.ImportFromDictionaryAsync(
                data, checkboxStates, startRow, mode, timeout, progress);
            
            if (result.IsSuccess)
            {
                // Note: GetCurrentStateAsync would need to be implemented or use alternative approach
                //_currentState = await GetCurrentStateAsync();
                await RefreshUIAsync();
                OnDataChanged(new DataChangedEventArgs("ImportDictionary", TotalRowCount));
                OnOperationCompleted(new OperationCompletedEventArgs("ImportDictionary", result.Value));
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Dictionary import failed: {result.Error}", result.Exception));
            }
            
            return result.IsSuccess;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Dictionary import failed");
            OnErrorOccurred(new ErrorEventArgs($"Dictionary import failed: {ex.Message}", ex));
            return false;
        }
    }
    
    /// <summary>
    /// Export data to dictionary list
    /// </summary>
    public async Task<List<Dictionary<string, object?>>?> ExportToDictionaryAsync(
        bool exportOnlyFiltered = false,
        bool includeValidationAlerts = false,
        bool exportOnlyChecked = false,
        TimeSpan? timeout = null,
        IProgress<ExportProgress>? progress = null)
    {
        try
        {
            if (_dataGridService == null) return null;
            
            var result = await _dataGridService.ExportToDictionaryAsync(
                includeValidationAlerts, exportOnlyChecked, exportOnlyFiltered, false, timeout, progress);
            
            if (result.IsSuccess)
            {
                OnOperationCompleted(new OperationCompletedEventArgs("ExportDictionary", result.Value));
                return result.Value;
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Dictionary export failed: {result.Error}", result.Exception));
                return null;
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Dictionary export failed");
            OnErrorOccurred(new ErrorEventArgs($"Dictionary export failed: {ex.Message}", ex));
            return null;
        }
    }
    
    #endregion

    #region UI: Search and Filter
    
    /// <summary>
    /// Search for text in grid data
    /// </summary>
    public async Task<List<SearchResult>?> SearchAsync(
        string searchText,
        IReadOnlyList<string>? targetColumns = null,
        bool caseSensitive = false,
        bool useRegex = false,
        int maxResults = 1000,
        TimeSpan? timeout = null)
    {
        try
        {
            if (_dataGridService == null) return null;
            
            var searchOptions = new SearchOptions
            {
                ColumnNames = targetColumns?.ToList(),
                CaseSensitive = caseSensitive,
                UseRegex = useRegex
            };
            
            var result = await _dataGridService.SearchAsync(searchText, searchOptions);
            
            if (result.IsSuccess)
            {
                // Convert single SearchResult to List<SearchResult>
                return result.Value != null ? new List<SearchResult> { result.Value } : new List<SearchResult>();
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Search failed: {result.Error}", result.Exception));
                return null;
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Search failed");
            OnErrorOccurred(new ErrorEventArgs($"Search failed: {ex.Message}", ex));
            return null;
        }
    }
    
    /// <summary>
    /// Apply filters to grid data
    /// </summary>
    public async Task<bool> ApplyFiltersAsync(
        IReadOnlyList<FilterDefinition> filters,
        FilterLogicOperator logicOperator = FilterLogicOperator.And,
        TimeSpan? timeout = null)
    {
        try
        {
            if (_dataGridService == null) return false;
            
            var filterExpressions = filters.Select(FilterExpression.FromFilterDefinition).ToList();
            var result = await _dataGridService.ApplyFiltersAsync(filterExpressions);
            
            if (result.IsSuccess)
            {
                // Note: GetCurrentStateAsync would need to be implemented or use alternative approach
                //_currentState = await GetCurrentStateAsync();
                await RefreshUIAsync();
                OnDataChanged(new DataChangedEventArgs("ApplyFilters", FilteredRowCount));
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Filter application failed: {result.Error}", result.Exception));
            }
            
            return result.IsSuccess;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Filter application failed");
            OnErrorOccurred(new ErrorEventArgs($"Filter application failed: {ex.Message}", ex));
            return false;
        }
    }
    
    #endregion

    #region UI: Validation
    
    /// <summary>
    /// Validate all grid data
    /// </summary>
    public async Task<List<ValidationError>?> ValidateAllAsync(
        bool onlyFiltered = false,
        bool onlyVisible = false,
        TimeSpan? timeout = null,
        IProgress<ValidationProgress>? progress = null)
    {
        try
        {
            if (_dataGridService == null) return null;
            
            var command = RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Internal.Application.UseCases.SearchGrid.ValidateAllCommand.Create(progress);
            
            var result = await _dataGridService.ValidateAllAsync(command.Progress);
            
            if (result.IsSuccess)
            {
                // Note: GetCurrentStateAsync would need to be implemented or use alternative approach
                //_currentState = await GetCurrentStateAsync();
                await RefreshUIAsync();
                OnValidationCompleted(new ValidationCompletedEventArgs(result.Value.ToList()));
                return result.Value.ToList();
            }
            else
            {
                OnErrorOccurred(new ErrorEventArgs($"Validation failed: {result.Error}", result.Exception));
                return null;
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Validation failed");
            OnErrorOccurred(new ErrorEventArgs($"Validation failed: {ex.Message}", ex));
            return null;
        }
    }
    
    #endregion

    #region UI: Private Methods
    
    private async Task<GridState?> GetCurrentStateAsync()
    {
        try
        {
            // Note: GetCurrentStateAsync method is not available in IDataGridService
            // This is a placeholder method for future implementation
            await Task.Delay(1); // Ensure async behavior
            return _currentState;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Failed to get current state");
            return null;
        }
    }
    
    private async Task RefreshUIAsync()
    {
        try
        {
            _xamlComponent.DispatcherQueue.TryEnqueue(() =>
            {
                // Update UI elements based on current state
                UpdateDataGridDisplay();
                UpdateStatusDisplay();
                UpdateValidationDisplay();
            });
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "UI refresh failed");
        }
    }
    
    private void UpdateDataGridDisplay()
    {
        if (_currentState?.Rows == null) return;
        
        // Update the ListView with current data
        // Convert grid rows to display format
        var displayItems = _currentState.Rows
            .Where(r => r.Data.Values.Any(v => v != null && !string.IsNullOrWhiteSpace(v.ToString())))
            .Select(r => FormatRowForDisplay(r))
            .ToList();
        
        // Update ItemsSource - this would be done via dispatcher
        // MainDataView.ItemsSource = displayItems;
    }
    
    private string FormatRowForDisplay(GridRow row)
    {
        // Simple text representation for now
        var values = row.Data.Values.Where(v => v != null).Select(v => v.ToString());
        return string.Join(" | ", values);
    }
    
    private void UpdateStatusDisplay()
    {
        // Update status bar or status display with current counts, etc.
    }
    
    private void UpdateValidationDisplay()
    {
        // Update validation error displays, highlights, etc.
    }
    
    /// <summary>
    /// UI: Update status bar with selection information
    /// SENIOR DESIGN: Centralized status management
    /// </summary>
    private void UpdateSelectionStatus(int selectedCount)
    {
        try
        {
            // UI: Update status bar display with selection count
            _logger?.LogInformation("Selection status updated: {SelectedCount} items selected", selectedCount);
            
            // TODO: Update actual status bar UI elements when available
            // Example: StatusBarSelectionText.Text = $"Selected: {selectedCount}";
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error updating selection status");
        }
    }
    
    #endregion

    #region UI: Event Handlers
    
    private void OnDataChanged(DataChangedEventArgs args) => DataChanged?.Invoke(this, args);
    
    private void OnValidationCompleted(ValidationCompletedEventArgs args) => ValidationCompleted?.Invoke(this, args);
    
    private void OnOperationCompleted(OperationCompletedEventArgs args) => OperationCompleted?.Invoke(this, args);
    
    private void OnErrorOccurred(ErrorEventArgs args) => ErrorOccurred?.Invoke(this, args);
    
    private void OnItemClicked(ItemClickedEventArgs args) => ItemClicked?.Invoke(this, args);
    
    private void OnSelectionChanged(DataGridSelectionChangedEventArgs args) => SelectionChanged?.Invoke(this, args);
    
    /// <summary>
    /// XAML EVENT: Handle item click events in the main data view
    /// SENIOR DESIGN: Centralized item interaction handling with error safety
    /// </summary>
    internal void HandleItemClick(object sender, ItemClickEventArgs e)
    {
        try
        {
            if (e.ClickedItem != null)
            {
                _logger?.LogInformation("Item clicked: {Item}", e.ClickedItem);

                // ENTERPRISE: Trigger item click event for external handling
                OnItemClicked(new ItemClickedEventArgs(e.ClickedItem));
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error handling item click");
            OnErrorOccurred(new ErrorEventArgs($"Item click failed: {ex.Message}", ex));
        }
    }

    private void MainDataView_ItemClick(object sender, ItemClickEventArgs e)
        => HandleItemClick(sender, e);
    
    /// <summary>
    /// XAML EVENT: Handle selection changes in the main data view
    /// SENIOR DESIGN: Robust selection management with validation
    /// </summary>
    internal void HandleSelectionChanged(object sender, Microsoft.UI.Xaml.Controls.SelectionChangedEventArgs e)
    {
        try
        {
            var listView = sender as ListView;
            if (listView != null)
            {
                _logger?.LogInformation("Selection changed: {SelectedCount} items", listView.SelectedItems.Count);

                // ENTERPRISE: Update internal state
                var selectedItems = listView.SelectedItems.ToList();

                // ENTERPRISE: Trigger selection changed event for external handling
                OnSelectionChanged(new DataGridSelectionChangedEventArgs(selectedItems));

                // UI: Update status bar with selection count
                UpdateSelectionStatus(selectedItems.Count);
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error handling selection change");
            OnErrorOccurred(new ErrorEventArgs($"Selection change failed: {ex.Message}", ex));
        }
    }

    private void MainDataView_SelectionChanged(object sender, Microsoft.UI.Xaml.Controls.SelectionChangedEventArgs e)
        => HandleSelectionChanged(sender, e);
    
    #endregion

    #region UI: Auto Row Height
    
    /// <summary>
    /// CONFIGURATION: Toggle auto row height functionality
    /// </summary>
    public async Task<bool> SetAutoRowHeightEnabledAsync(bool enabled)
    {
        try
        {
            if (_autoRowHeightService != null)
            {
                var result = await _autoRowHeightService.SetEnabledAsync(enabled, refreshExistingRows: true);
                if (result.IsSuccess)
                {
                    _logger?.LogInformation("Auto row height {Status}", enabled ? "enabled" : "disabled");
                    await RefreshUIAsync();
                    return true;
                }
                else
                {
                    OnErrorOccurred(new ErrorEventArgs($"Failed to {(enabled ? "enable" : "disable")} auto row height: {result.Error}"));
                    return false;
                }
            }
            return false;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error toggling auto row height");
            OnErrorOccurred(new ErrorEventArgs($"Auto row height toggle failed: {ex.Message}", ex));
            return false;
        }
    }
    
    /// <summary>
    /// Get current auto row height enabled state
    /// </summary>
    public bool IsAutoRowHeightEnabled => _autoRowHeightService?.IsEnabled ?? false;
    
    #endregion

    #region UI: Dispose Pattern
    
    public void Dispose()
    {
        if (_isDisposed) return;
        
        try
        {
            _dataGridService?.Dispose();
            _autoRowHeightService?.Dispose();
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error disposing DataGrid services");
        }
        
        _isDisposed = true;
    }
    
    #endregion
}

#region UI: Event Args Classes

public class DataChangedEventArgs : EventArgs
{
    public string Operation { get; }
    public int AffectedRows { get; }
    public DateTime Timestamp { get; }
    
    public DataChangedEventArgs(string operation, int affectedRows)
    {
        Operation = operation;
        AffectedRows = affectedRows;
        Timestamp = DateTime.UtcNow;
    }
}

public class ValidationCompletedEventArgs : EventArgs
{
    internal IReadOnlyList<ValidationError> ValidationErrors { get; }
    internal DateTime Timestamp { get; }
    
    internal ValidationCompletedEventArgs(IReadOnlyList<ValidationError> validationErrors)
    {
        ValidationErrors = validationErrors;
        Timestamp = DateTime.UtcNow;
    }
}

public class OperationCompletedEventArgs : EventArgs
{
    public string Operation { get; }
    public object? Result { get; }
    public DateTime Timestamp { get; }
    
    public OperationCompletedEventArgs(string operation, object? result)
    {
        Operation = operation;
        Result = result;
        Timestamp = DateTime.UtcNow;
    }
}

public class ErrorEventArgs : EventArgs
{
    public string Message { get; }
    public Exception? Exception { get; }
    public DateTime Timestamp { get; }
    
    public ErrorEventArgs(string message, Exception? exception = null)
    {
        Message = message;
        Exception = exception;
        Timestamp = DateTime.UtcNow;
    }
}

/// <summary>
/// XAML EVENT ARGS: Item click event arguments
/// SENIOR DESIGN: Enterprise-grade event handling with type safety
/// </summary>
public class ItemClickedEventArgs : EventArgs
{
    public object ClickedItem { get; }
    public DateTime Timestamp { get; }
    
    public ItemClickedEventArgs(object clickedItem)
    {
        ClickedItem = clickedItem;
        Timestamp = DateTime.UtcNow;
    }
}

/// <summary>
/// XAML EVENT ARGS: Selection change event arguments  
/// SENIOR DESIGN: Robust selection management with collection safety
/// </summary>
public class DataGridSelectionChangedEventArgs : EventArgs
{
    public IReadOnlyList<object> SelectedItems { get; }
    public int SelectedCount => SelectedItems.Count;
    public DateTime Timestamp { get; }
    
    public DataGridSelectionChangedEventArgs(IList<object> selectedItems)
    {
        SelectedItems = selectedItems.ToList().AsReadOnly();
        Timestamp = DateTime.UtcNow;
    }
}

/// <summary>
/// View model for DataGrid rows displayed in UI
/// </summary>
public class DataGridRowViewModel
{
    public string ID { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Status { get; set; } = string.Empty;
    public string ValidationAlerts { get; set; } = string.Empty;

    /// <summary>
    /// SENIOR FEATURE: Computed property to indicate if there are validation errors
    /// CLEAN ARCHITECTURE: Business logic property for UI conditional rendering
    /// </summary>
    public bool HasValidationErrors => !string.IsNullOrWhiteSpace(ValidationAlerts);

    /// <summary>
    /// SENIOR FEATURE: Get conditional border color based on validation errors
    /// CLEAN ARCHITECTURE: UI-specific computed property with configurable colors
    /// </summary>
    public Microsoft.UI.Xaml.Media.SolidColorBrush GetConditionalBorderBrush(
        Color normalBorderColor,
        Color errorBorderColor)
    {
        return HasValidationErrors
            ? new Microsoft.UI.Xaml.Media.SolidColorBrush(errorBorderColor)
            : new Microsoft.UI.Xaml.Media.SolidColorBrush(normalBorderColor);
    }

    public override string ToString()
    {
        return $"{ID} | {Name} | {Email} | {Status}";
    }
}

#endregion